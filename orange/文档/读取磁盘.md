扩展 BIOS 功能是传统 BIOS 的增强功能，旨在解决传统 BIOS 的限制，特别是磁盘访问中的地址范围和容量限制问题。通过扩展 BIOS 功能，系统可以支持更大的磁盘容量以及更高效的磁盘操作。

以下是关于扩展 BIOS 功能的详细讲解：

1. 背景

传统 BIOS 的限制
	•	CHS（柱面/磁头/扇区）寻址模式：
	•	CHS 寻址方式使用柱面、磁头和扇区的组合定位磁盘数据。
	•	每个柱面、磁头和扇区都有固定的最大值：
	•	柱面（CH）：0–1023
	•	磁头（DH）：0–255
	•	扇区（CL）：1–63
	•	最大可寻址磁盘容量为：

1024 柱面 × 256 磁头 × 63 扇区 × 512 字节 = ~8 GB

对于现代磁盘，这显然远远不够。

	•	读取效率低：
	•	传统 BIOS 每次读取一个或少量扇区，操作频繁且容易跨越边界导致错误。

扩展功能的目标
	•	提供对更大容量磁盘的支持（>8GB）。
	•	使用 LBA（逻辑块地址）模式代替 CHS 模式。
	•	提供批量操作功能，例如一次性读取或写入多个扇区。
	•	增强错误检测和恢复能力。

2. 扩展 BIOS 功能（INT 0x13，AH=0x41 到 AH=0x48）

扩展 BIOS 功能主要通过 INT 0x13 的高级功能号实现，常见功能包括：

功能号 (AH)	描述
0x41	检测扩展功能支持
0x42	使用 LBA 模式读取数据
0x43	使用 LBA 模式写入数据
0x44	校验磁盘扇区
0x45	获取磁盘参数
0x46	扩展磁盘检测
0x47	获取扩展磁盘参数

3. 扩展功能详解

功能号 0x41：检测扩展功能支持
	•	用于检测 BIOS 是否支持扩展磁盘功能。

输入：
	•	AH = 0x41（功能号）
	•	BX = 0x55AA（扩展支持标识符）
	•	DL = 磁盘编号（如 0x80 表示第一个硬盘）

输出：
	•	CF = 0（无错误时）
	•	BX = 0xAA55（表示扩展功能支持）
	•	AH = 扩展功能支持标志位：
	•	位 0：支持扩展读取/写入（功能号 0x42 和 0x43）
	•	位 1：支持 64 位地址访问
	•	CF = 1（不支持扩展功能）

示例代码：

mov $0x41, %ah        ; 功能号
mov $0x55AA, %bx      ; 扩展支持标识符
mov $0x80, %dl        ; 磁盘编号
int $0x13             ; 调用中断
jc no_support         ; 检查是否支持扩展功能
cmp $0xAA55, %bx      ; 验证返回值
jne no_support

功能号 0x42：扩展读取
	•	使用 LBA 模式读取磁盘数据，比传统 CHS 模式更加高效。

输入：
	•	AH = 0x42（功能号）
	•	DL = 磁盘编号
	•	DS:SI = 数据包地址（包含读取参数的结构）

数据包格式（16 字节）：

偏移量	大小	描述
0x00	2 字节	数据包大小（通常为 0x10）
0x02	1 字节	保留（必须为 0）
0x03	1 字节	读取的扇区数
0x04	4 字节	数据缓冲区的物理地址
0x08	8 字节	起始 LBA 地址

输出：
	•	CF = 0（无错误时）
	•	CF = 1（错误时，AH 返回错误代码）

示例代码：

mov $0x42, %ah        ; 功能号
mov $0x80, %dl        ; 磁盘编号
mov $data_packet, %si ; 数据包地址
mov %cs, %ds          ; 数据包段地址
int $0x13             ; 调用中断
jc read_error         ; 如果 CF 被置位，表示出错

数据包设置示例：

data_packet:
    dw 0x10           ; 数据包大小
    db 0              ; 保留
    db 1              ; 读取的扇区数
    dd 0x7E00         ; 缓冲区地址
    dq 0              ; 起始 LBA 地址

功能号 0x43：扩展写入
	•	格式和功能与 0x42 类似，但用于写入磁盘。

功能号 0x45：获取磁盘参数
	•	返回磁盘的几何和容量信息。

输入：
	•	AH = 0x45（功能号）
	•	DL = 磁盘编号

输出：
	•	CF = 0（无错误时）
	•	CX:DX（返回的总扇区数）
	•	SI:DI（返回的总容量，以字节为单位）

4. 扩展功能的优点
	•	支持大容量磁盘：突破传统 BIOS 的 8GB 限制。
	•	简化操作：使用 LBA 模式，不需要计算 CHS 参数。
	•	批量操作：支持一次性读取/写入多个扇区，提高效率。
	•	增强兼容性：更好地支持现代硬盘（包括 SSD 和 NVMe）。

5. 注意事项
	1.	BIOS 支持要求：
	•	并非所有 BIOS 都支持扩展功能。通过功能号 0x41 检测支持情况。
	2.	内存地址对齐：
	•	数据包和缓冲区地址通常需要 4KB 对齐。
	3.	现代系统的取代：
	•	扩展 BIOS 功能在 UEFI 和现代操作系统中已被废弃，现代系统使用 UEFI 的 GPT 分区和更高效的存储协议（如 NVMe 驱动）。

6. 示例代码：扩展读取 1 个扇区

org 0x7C00              ; 引导程序加载地址

start:
    ; 初始化数据包
    mov $0x10, data_packet   ; 数据包大小
    mov $0x00, data_packet+2 ; 保留字段
    mov $1, data_packet+3    ; 读取 1 个扇区
    mov $0x7E00, data_packet+4 ; 缓冲区地址
    mov $0, data_packet+8    ; 起始 LBA 地址（低位）
    mov $0, data_packet+12   ; 起始 LBA 地址（高位）

    ; 调用扩展读取功能
    mov $0x42, %ah
    mov $0x80, %dl
    lea data_packet, %si
    mov %cs, %ds
    int $0x13
    jc read_error            ; 如果失败，跳转到错误处理

    ; 成功读取后继续
    jmp $

read_error:
    hlt                      ; 错误时停止

data_packet: times 16 db 0

总结

扩展 BIOS 功能是传统 BIOS 的重要增强，为现代大容量磁盘的支持奠定了基础。通过 LBA 寻址模式，它提供了更高效、更简单的磁盘操作接口，避免了传统 CHS 的复杂性和容量限制。尽管现代系统逐步转向 UEFI，但在引导加载器或裸机开发中，扩展 BIOS 功能仍然非常实用。